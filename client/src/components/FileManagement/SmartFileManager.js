/**
 * SmartFileManager - Professional File Management Integration
 * Combines all file features: download, media viewing, background customization
 */

import React, { useState, useCallback } from 'react';
import { 
  FiFile, 
  FiImage, 
  FiVideo, 
  FiMusic,\n  FiDownload,\n  FiEye,\n  FiSettings,\n  FiMoreHorizontal\n} from 'react-icons/fi';\nimport FileDownloadManager from './FileDownloadManager';\nimport MediaViewer from '../MediaViewer/MediaViewer';\nimport BackgroundCustomizer from '../BackgroundCustomizer/BackgroundCustomizer';\nimport TelegramVoiceRecorder from '../Voice/TelegramVoiceRecorder';\nimport './SmartFileManager.css';\n\nconst SmartFileManager = ({ \n  files = [], \n  onFileAction,\n  onBackgroundChange,\n  currentBackground,\n  className = ''\n}) => {\n  const [selectedFile, setSelectedFile] = useState(null);\n  const [showDownloadModal, setShowDownloadModal] = useState(false);\n  const [showMediaViewer, setShowMediaViewer] = useState(false);\n  const [showBackgroundCustomizer, setShowBackgroundCustomizer] = useState(false);\n  const [mediaIndex, setMediaIndex] = useState(0);\n  const [showVoiceRecorder, setShowVoiceRecorder] = useState(false);\n\n  // Get file type icon\n  const getFileIcon = (file) => {\n    const type = file.type || '';\n    \n    if (type.startsWith('image/')) return <FiImage />;\n    if (type.startsWith('video/')) return <FiVideo />;\n    if (type.startsWith('audio/')) return <FiMusic />;\n    return <FiFile />;\n  };\n\n  // Check if file is viewable in media viewer\n  const isMediaFile = (file) => {\n    const type = file.type || '';\n    return type.startsWith('image/') || type.startsWith('video/');\n  };\n\n  // Handle file download\n  const handleDownload = useCallback((file) => {\n    setSelectedFile(file);\n    setShowDownloadModal(true);\n  }, []);\n\n  // Handle media viewing\n  const handleViewMedia = useCallback((file, index = 0) => {\n    if (!isMediaFile(file)) return;\n    \n    setSelectedFile(file);\n    setMediaIndex(index);\n    setShowMediaViewer(true);\n  }, []);\n\n  // Handle background customization\n  const handleCustomizeBackground = useCallback(() => {\n    setShowBackgroundCustomizer(true);\n  }, []);\n\n  // Handle voice message\n  const handleVoiceMessage = useCallback((voiceData) => {\n    const voiceFile = {\n      id: `voice_${Date.now()}`,\n      name: `Voice Message ${new Date().toLocaleTimeString()}`,\n      type: 'audio/webm',\n      size: voiceData.blob.size,\n      url: voiceData.url,\n      duration: voiceData.duration,\n      waveform: voiceData.waveform,\n      isVoiceMessage: true,\n      timestamp: voiceData.timestamp\n    };\n    \n    onFileAction?.('voice_message', voiceFile);\n    setShowVoiceRecorder(false);\n  }, [onFileAction]);\n\n  // Get media files for navigation\n  const mediaFiles = files.filter(isMediaFile);\n  \n  // Navigate media\n  const handleNextMedia = () => {\n    const currentIndex = mediaFiles.findIndex(f => f.id === selectedFile?.id);\n    const nextIndex = (currentIndex + 1) % mediaFiles.length;\n    setSelectedFile(mediaFiles[nextIndex]);\n    setMediaIndex(nextIndex);\n  };\n\n  const handlePreviousMedia = () => {\n    const currentIndex = mediaFiles.findIndex(f => f.id === selectedFile?.id);\n    const prevIndex = currentIndex > 0 ? currentIndex - 1 : mediaFiles.length - 1;\n    setSelectedFile(mediaFiles[prevIndex]);\n    setMediaIndex(prevIndex);\n  };\n\n  // Format file size\n  const formatFileSize = (bytes) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  // Format date\n  const formatDate = (timestamp) => {\n    return new Date(timestamp).toLocaleDateString('en-US', {\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  return (\n    <div className={`smart-file-manager ${className}`}>\n      {/* Header Controls */}\n      <div className=\"file-manager-header\">\n        <h3>Files & Media</h3>\n        <div className=\"header-actions\">\n          <button \n            className=\"action-btn\"\n            onClick={() => setShowVoiceRecorder(!showVoiceRecorder)}\n            title=\"Voice Message\"\n          >\n            <FiMusic />\n          </button>\n          <button \n            className=\"action-btn\"\n            onClick={handleCustomizeBackground}\n            title=\"Customize Background\"\n          >\n            <FiSettings />\n          </button>\n        </div>\n      </div>\n\n      {/* Voice Recorder */}\n      {showVoiceRecorder && (\n        <div className=\"voice-recorder-section\">\n          <TelegramVoiceRecorder\n            onVoiceMessage={handleVoiceMessage}\n            onCancel={() => setShowVoiceRecorder(false)}\n          />\n        </div>\n      )}\n\n      {/* Files Grid */}\n      <div className=\"files-grid\">\n        {files.length === 0 ? (\n          <div className=\"empty-state\">\n            <FiFile className=\"empty-icon\" />\n            <p>No files shared yet</p>\n            <span>Files and media will appear here</span>\n          </div>\n        ) : (\n          files.map((file, index) => (\n            <div key={file.id} className=\"file-item\">\n              <div className=\"file-preview\">\n                {file.type?.startsWith('image/') ? (\n                  <img \n                    src={file.url} \n                    alt={file.name}\n                    onClick={() => handleViewMedia(file, index)}\n                  />\n                ) : file.type?.startsWith('video/') ? (\n                  <div className=\"video-preview\" onClick={() => handleViewMedia(file, index)}>\n                    <video src={file.url} />\n                    <div className=\"play-overlay\">\n                      <FiVideo />\n                    </div>\n                  </div>\n                ) : (\n                  <div className=\"file-icon-preview\">\n                    {getFileIcon(file)}\n                  </div>\n                )}\n                \n                {file.isVoiceMessage && (\n                  <div className=\"voice-indicator\">\n                    <FiMusic />\n                    <span>{Math.round(file.duration)}s</span>\n                  </div>\n                )}\n              </div>\n              \n              <div className=\"file-info\">\n                <div className=\"file-name\" title={file.name}>\n                  {file.name}\n                </div>\n                <div className=\"file-meta\">\n                  <span className=\"file-size\">{formatFileSize(file.size)}</span>\n                  {file.timestamp && (\n                    <span className=\"file-date\">{formatDate(file.timestamp)}</span>\n                  )}\n                </div>\n              </div>\n              \n              <div className=\"file-actions\">\n                {isMediaFile(file) && (\n                  <button \n                    className=\"file-action-btn\"\n                    onClick={() => handleViewMedia(file, index)}\n                    title=\"View\"\n                  >\n                    <FiEye />\n                  </button>\n                )}\n                \n                <button \n                  className=\"file-action-btn\"\n                  onClick={() => handleDownload(file)}\n                  title=\"Download\"\n                >\n                  <FiDownload />\n                </button>\n                \n                <button \n                  className=\"file-action-btn\"\n                  onClick={() => onFileAction?.('more', file)}\n                  title=\"More options\"\n                >\n                  <FiMoreHorizontal />\n                </button>\n              </div>\n            </div>\n          ))\n        )}\n      </div>\n\n      {/* Download Modal */}\n      {showDownloadModal && selectedFile && (\n        <FileDownloadManager\n          file={selectedFile}\n          onDownloadComplete={(results) => {\n            console.log('Download completed:', results);\n            setShowDownloadModal(false);\n            onFileAction?.('download_complete', selectedFile, results);\n          }}\n          onCancel={() => setShowDownloadModal(false)}\n        />\n      )}\n\n      {/* Media Viewer */}\n      {showMediaViewer && selectedFile && isMediaFile(selectedFile) && (\n        <MediaViewer\n          media={selectedFile}\n          onClose={() => setShowMediaViewer(false)}\n          onNext={mediaFiles.length > 1 ? handleNextMedia : null}\n          onPrevious={mediaFiles.length > 1 ? handlePreviousMedia : null}\n          showNavigation={mediaFiles.length > 1}\n        />\n      )}\n\n      {/* Background Customizer */}\n      {showBackgroundCustomizer && (\n        <BackgroundCustomizer\n          onBackgroundChange={(backgroundData) => {\n            onBackgroundChange?.(backgroundData);\n            setShowBackgroundCustomizer(false);\n          }}\n          onClose={() => setShowBackgroundCustomizer(false)}\n          currentBackground={currentBackground}\n        />\n      )}\n    </div>\n  );\n};\n\nexport default SmartFileManager;"